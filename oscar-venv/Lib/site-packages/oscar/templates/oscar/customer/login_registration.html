{% extends "oscar/layout.html" %}
{% load i18n %}

{% block title %}
    {% trans 'Login or register' %} | {{ block.super }}
{% endblock %}

{% block breadcrumbs %}
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ homepage_url }}">{% trans 'Home' %}</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{% trans 'Login or register' %}</li>
        </ol>
    </nav>
{% endblock %}

{% block header %}{% endblock %}

{% block content %}

    <div class="row">
        <div class="col-sm-6 login_form">
            <form id="login_form" action="{{ request.get_full_path }}" method="post" class="card card-body bg-light" >
                <h2>{% trans 'Log In' %}</h2>
                {% csrf_token %}
                {% include "oscar/partials/form_fields.html" with form=login_form %}
                <p><a href="{% url 'password-reset' %}">{% trans "I've forgotten my password" %}</a></p>
                <button name="login_submit" type="submit" value="Log In" class="btn btn-lg btn-primary" data-loading-text="{% trans "Logging in..." %}">{% trans 'Log In' %}</button>
            </form>
        </div>
        <div class="col-sm-6 register_form">
            <form id="custom-register-form" class="card card-body bg-light">
                {% csrf_token %}
                <div class="form-group">
                    <label>Tipo de Utilizador:</label><br>
                    <label><input type="radio" name="tipo" value="cliente" checked> Cliente</label>
                    <label><input type="radio" name="tipo" value="fornecedor"> Fornecedor</label>
                </div>

                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" name="email" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" name="username" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" name="password" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>Confirmar Password:</label>
                    <input type="password" name="password2" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>Telefone:</label>
                    <input type="text" name="telefone" class="form-control" required>
                </div>

                <div class="form-group" id="empresa-container" style="display: none;">
                    <label>Empresa:</label>
                    <input type="text" name="empresa" class="form-control">
                </div>

                <button type="submit" class="btn btn-primary btn-block mt-3">Registrar</button>
                <div id="mensagem" class="mt-3"></div>
            </form>
        </div>
    </div>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("custom-register-form");
    const tipoRadios = document.querySelectorAll('input[name="tipo"]');
    const empresaContainer = document.getElementById("empresa-container");

    // Alternar exibição da empresa
    tipoRadios.forEach(radio => {
        radio.addEventListener("change", () => {
            empresaContainer.style.display = (radio.value === "fornecedor" && radio.checked) ? "block" : "none";
        });
    });

    form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const tipo = document.querySelector('input[name="tipo"]:checked').value;
        const url = tipo === "cliente" ? "/api/register/cliente/" : "/api/register/fornecedor/";

        const senha = form.password.value;
        const confirmar = form.password2.value;
        if (senha !== confirmar) {
            document.getElementById("mensagem").innerHTML = "<p class='text-danger'>As senhas não coincidem.</p>";
            return;
        }

        const data = {
            user: {
                username: form.username.value,
                email: form.email.value,
                password: senha
            },
            telefone: form.telefone.value
        };

        if (tipo === "fornecedor") {
            data.empresa = form.empresa.value;
        }

        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        const mensagemDiv = document.getElementById("mensagem");
        if (response.ok) {
            mensagemDiv.innerHTML = "<p class='text-success'>Utilizador registado com sucesso!</p>";
            form.reset();
            empresaContainer.style.display = "none";
        } else {
            const erro = await response.json();
            mensagemDiv.innerHTML = "<p class='text-danger'>Erro: " + JSON.stringify(erro) + "</p>";
        }
    });

    // Captura o token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>  

{% endblock content %}
